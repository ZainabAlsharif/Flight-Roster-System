<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tabular View</title>

  <link rel="stylesheet" href="/public/styles/tabular-view.css" />

  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
</head>

<body>
  <div class="app-wrapper">
    <header class="main-header container">
      <div class="logo-container">
        <div class="airplane-icon">
          <svg viewBox="0 0 44 44" fill="none">
            <path d="M37.6933 7.16833C38.775 8.25 38.775 9.99167 37.6933 11.055L30.5617 18.1867L34.4483 35.035L31.8633 37.6383L24.75 24.0167L17.6 31.1667L18.26 35.695L16.2983 37.6383L13.0717 31.8083L7.22333 28.5633L9.16667 26.5833L13.75 27.2617L20.845 20.1667L7.22333 12.9983L9.82667 10.4133L26.675 14.3L33.8067 7.16833C34.8333 6.105 36.6667 6.105 37.6933 7.16833Z" fill="white" />
          </svg>
        </div>
        <h1 class="brand-name">FlyTech</h1>
      </div>

      <nav class="nav-container">
        <a class="nav-link" onclick="window.location.href='./about-us.html';">About Us</a>
        <a class="login-button" onclick="window.location.href='./login.html';">Log-in</a>
      </nav>
    </header>

    <main class="container">
      <div class="main-card">
        <div class="back-row">
          <button class="back-button" onclick="window.location.href='./assigned-flight-list.html';">
            <i class="fas fa-arrow-left" aria-hidden="true"></i>
          </button>
        </div>

        <div class="flight-info">
          <h2 class="flight-title">Flight: -</h2>
          <p class="flight-details">-</p>
        </div>

        <hr class="divider-line" />

        <!-- Tabs -->
        <div class="view-tabs">
          <!-- FIX: Plane View is now clickable -->
          <div class="tab-item" onclick="navigateToPlaneView()">
            <div class="tab-icon">
              <i class="fas fa-plane"></i>
            </div>
            <span>Plane View</span>
          </div>

          <div class="tab-item tab-active">
            <div class="tab-icon">
              <i class="fas fa-table"></i>
            </div>
            <span>Tabular View</span>
          </div>

          <div class="tab-item" onclick="navigateToExtendedView()">
            <div class="tab-icon">
              <i class="fas fa-list"></i>
            </div>
            <span>Extended View</span>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <div class="table-row table-header-row">
              <div class="table-cell cell-id"><p>ID</p></div>
              <div class="table-cell cell-flexible"><p>Role</p></div>
              <div class="table-cell cell-flexible"><p>Name</p></div>
              <div class="table-cell cell-flexible"><p>Seat</p></div>
            </div>
            <div id="tableBody"></div>
          </div>
        </div>

        <div class="export-container">
          <button class="export-button" id="exportJsonBtn" type="button">
            <div class="download-icon">
              <svg viewBox="0 0 28 28" fill="none">
                <path d="M14 18.6667L8.16667 12.8333L9.8 11.1417L12.8333 14.175V4.66667H15.1667V14.175L18.2 11.1417L19.8333 12.8333L14 18.6667ZM7 23.3333C6.35833 23.3333 5.80922 23.1051 5.35267 22.6485C4.89611 22.1919 4.66744 21.6424 4.66667 21V17.5H7V21H21V17.5H23.3333V21C23.3333 21.6417 23.1051 22.1912 22.6485 22.6485C22.1919 23.1058 21.6424 23.3341 21 23.3333H7Z" fill="#FEFFFF" />
              </svg>
            </div>
            <span class="export-text">Export JSON</span>
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    function getFlightNumber() {
      const params = new URLSearchParams(window.location.search);
      return params.get("flightNumber") || "FT201";
    }

    function navigateToPlaneView() {
      const flightNumber = getFlightNumber();
      window.location.href = `/plane-view?flightNumber=${encodeURIComponent(flightNumber)}`;
    }

    function navigateToExtendedView() {
      const flightNumber = getFlightNumber();
      window.location.href = `/extended-view?flightNumber=${encodeURIComponent(flightNumber)}`;
    }

    function downloadRosterJson(flightNumber) {
      window.location.href = `/api/roster/${encodeURIComponent(flightNumber)}/export`;
    }

    function setFlightHeader(flight) {
      document.querySelector(".flight-title").textContent = `Flight: ${flight.FlightNumber}`;
      document.querySelector(".flight-details").textContent =
        `${flight.SourceAirportCode} â†’ ${flight.DestinationAirportCode} | ${flight.FlightDateTime}`;
    }

    function addRow(container, id, role, name, seat) {
      const row = document.createElement("div");
      row.className = "table-row table-data-row";
      row.innerHTML = `
        <div class="table-cell cell-id"><p>${id}</p></div>
        <div class="table-cell cell-flexible"><p>${role}</p></div>
        <div class="table-cell cell-flexible"><p>${name}</p></div>
        <div class="table-cell cell-flexible"><p>${seat ?? "-"}</p></div>
      `;
      container.appendChild(row);
    }

    async function loadRoster() {
      const flightNumber = getFlightNumber();

      try {
        const response = await fetch(`/api/roster/${encodeURIComponent(flightNumber)}`);
        if (!response.ok) {
          throw new Error(`Roster API failed: ${response.status}`);
        }

        const data = await response.json();

        if (data.flight) setFlightHeader(data.flight);

        const container = document.getElementById("tableBody");
        container.innerHTML = "";

        // Pilots
        (data.pilots || []).forEach(p => {
          addRow(container, p.PilotId, "Pilot", p.Name, "-");
        });

        // Cabin crew
        (data.attendants || []).forEach(a => {
          addRow(container, a.AttendantId, a.AttendantType, a.Name, "-");
        });

        // Passengers
        (data.passengers || []).forEach(p => {
          addRow(
            container,
            p.PassengerId,
            `Passenger (${p.SeatType})`,
            p.Name,
            p.SeatNumber
          );
        });
      } catch (err) {
        console.error(err);
        document.getElementById("tableBody").innerHTML =
          `<div style="padding:16px;color:#b00020;font-weight:600;">Failed to load roster data.</div>`;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadRoster();

      const btn = document.getElementById("exportJsonBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          downloadRosterJson(getFlightNumber());
        });
      }
    });
  </script>
</body>
</html>
